import React, { useState } from 'react';
import * as XLSX from 'xlsx';
import { Upload, Download, FileSpreadsheet } from 'lucide-react';

export default function XLSXCombiner() {
  const [combinedData, setCombinedData] = useState(null);
  const [fileName, setFileName] = useState('');
  const [processing, setProcessing] = useState(false);

  const handleFileUpload = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setProcessing(true);
    setFileName(file.name.replace('.xlsx', ''));

    try {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data, { type: 'array' });
      
      // Create a map to store microbe -> {sample1: abundance1, sample2: abundance2, ...}
      const microbeMap = new Map();
      const sampleNames = [];

      // Process each sheet
      workbook.SheetNames.forEach(sheetName => {
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        
        // Skip empty sheets
        if (jsonData.length < 2) return;
        
        sampleNames.push(sheetName);
        
        // Start from row 1 (skip header if present) or row 0
        const startRow = jsonData[0]?.[0] === 'Microbe' || typeof jsonData[0]?.[0] === 'string' ? 1 : 0;
        
        for (let i = startRow; i < jsonData.length; i++) {
          const row = jsonData[i];
          if (!row || row.length < 2) continue;
          
          const microbe = String(row[0] || '').trim();
          const abundance = row[1];
          
          if (!microbe) continue;
          
          if (!microbeMap.has(microbe)) {
            microbeMap.set(microbe, {});
          }
          
          microbeMap.get(microbe)[sheetName] = abundance;
        }
      });

      // Convert map to array format for display and export
      const combined = Array.from(microbeMap.entries()).map(([microbe, samples]) => {
        const row = { Microbe: microbe };
        sampleNames.forEach(sample => {
          row[sample] = samples[sample] ?? '';
        });
        return row;
      });

      setCombinedData({ data: combined, columns: ['Microbe', ...sampleNames] });
    } catch (error) {
      console.error('Error processing file:', error);
      alert('Error processing file. Please ensure it\'s a valid Excel file.');
    } finally {
      setProcessing(false);
    }
  };

  const downloadExcel = () => {
    if (!combinedData) return;

    const ws = XLSX.utils.json_to_sheet(combinedData.data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Combined');
    XLSX.writeFile(wb, `${fileName}_combined.xlsx`);
  };

  const downloadCSV = () => {
    if (!combinedData) return;

    const ws = XLSX.utils.json_to_sheet(combinedData.data);
    const csv = XLSX.utils.sheet_to_csv(ws);
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${fileName}_combined.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-lg shadow-lg p-8">
          <div className="flex items-center gap-3 mb-6">
            <FileSpreadsheet className="w-8 h-8 text-indigo-600" />
            <h1 className="text-3xl font-bold text-gray-800">Excel Sheet Combiner</h1>
          </div>
          
          <p className="text-gray-600 mb-6">
            Upload an Excel file to combine all sheets. Each sheet's name becomes a column header, 
            with microbe names as keys and abundance values merged into one table.
          </p>

          <div className="mb-8">
            <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-indigo-300 rounded-lg cursor-pointer bg-indigo-50 hover:bg-indigo-100 transition">
              <div className="flex flex-col items-center justify-center pt-5 pb-6">
                <Upload className="w-10 h-10 text-indigo-500 mb-2" />
                <p className="text-sm text-gray-600">
                  <span className="font-semibold">Click to upload</span> or drag and drop
                </p>
                <p className="text-xs text-gray-500">Excel files (.xlsx)</p>
              </div>
              <input
                type="file"
                className="hidden"
                accept=".xlsx,.xls"
                onChange={handleFileUpload}
              />
            </label>
          </div>

          {processing && (
            <div className="text-center py-4">
              <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
              <p className="text-gray-600 mt-2">Processing file...</p>
            </div>
          )}

          {combinedData && (
            <div>
              <div className="flex gap-3 mb-4">
                <button
                  onClick={downloadExcel}
                  className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
                >
                  <Download className="w-4 h-4" />
                  Download Excel
                </button>
                <button
                  onClick={downloadCSV}
                  className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                >
                  <Download className="w-4 h-4" />
                  Download CSV
                </button>
              </div>

              <div className="border rounded-lg overflow-hidden">
                <div className="overflow-x-auto max-h-96">
                  <table className="w-full text-sm">
                    <thead className="bg-indigo-600 text-white sticky top-0">
                      <tr>
                        {combinedData.columns.map((col, i) => (
                          <th key={i} className="px-4 py-2 text-left font-semibold">
                            {col}
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {combinedData.data.map((row, i) => (
                        <tr key={i} className="border-b hover:bg-gray-50">
                          {combinedData.columns.map((col, j) => (
                            <td key={j} className="px-4 py-2">
                              {row[col]}
                            </td>
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              <p className="text-sm text-gray-500 mt-4">
                Total microbes: {combinedData.data.length} | 
                Total samples: {combinedData.columns.length - 1}
              </p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
